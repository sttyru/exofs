# exofs

**exofs** - набор sh-скриптов, предназначенных для автоматизации операций по мониторованию файловых **FUSE** (sshfs, curlftpfs).

**exofs** будет полезен в тех случаях, когда нет технической возможности (либо - нежелательно) изменять `/etc/fstab`, однако при запуске операционной системы, либо - по наступлению какого-либо события необходимо получить смонтированную файловую систему FUSE. Кроме того, благодаря простым сценариям мониторинга, **exofs** сможет помочь в ситуациях, когда требуется проанализировать доступность файловой системы.

### Типичный сценарий использования

В качестве типичного сценария использования можно представить следующую ситуацию. 

**Условия**

Имеется VPS/VDS с установленной `OS Linux`. Основное предназначение ВМ: веб-хостинг. Пользователь, от имени которого осуществляется вход в систему, имеет ограниченные права - отредактировать `/etc/fstab` или `/etc/autofs` - невозможно.

**Задача**

Обеспечить автоматическое монтирование (с помощью `FUSE sshfs`) удалённого каталога после перезагрузки системы. Уведомление о результатах выполнения операции - отправить по е-майл. 

**Решение**

- Выполнить установку **exofs**.
- Выполнить настройку параметров для автоматического монтирования удалённого назначения по  `sshfs`. 
- Добавить в планировщик `cron` соответствующую инструкцию (`@reboot`).

## Установка, настройка

### Установка exofs

```
# cd /tmp
# git clone https://gridedge.ru/octans/exofs
# cd exofs/
# mv fileset /opt/exofs/
```
`/opt/exofs` - рекомендуемый для установки ПО каталог. Для сохранения совместимости, в примерах ниже корневой каталог - `/opt/exofs` - обозначен через `$EXOFS_ROOT`. 

### Настройка exofs

Настройка **exofs** осуществляется путём создания конфигурационного **файла с учётными данными** для доступа к удалённой файловой системе, а также **файла с описанием задачи** .

#### Файл с учётными данными

Файл с учётными данными может быть расположен в любом каталоге, который доступен для текущего пользователя __для чтения__. Однако, настоятельно рекомендуется размещать файл с соответствующим опознаваемым именем в `$EXOFS_ROOT/etc`. 

**Файл для curlftpfs**

```
username=YOUR_USERNAME
password=YOUR_PASSWORD
```
Где `username` и `password` - имя пользователя и пароль для подключения по FTP.

**Файл для sshfs**

```
username=YOUR_USERNAME
keyfile=PATH_TO_KEYFILE
```

Где `username` и `keyfile` - имя пользователя и путь к файлу с ключом, который используется для подключения по **ssh**.

#### Файл с заданием

Файл с заданием представляет собой **исполняемый** (не забудьте выполнить `chmod +x`) скрипт, где вызывается с параметрами сценарий **exofs**.

**Ключи и значения**:

- **--jobid** - идентификатор задания (фигурирует в логах и заголовке е-майл сообщения).

- **--jobtype** - тип задачи (для текущей версии - только **mount**).

- **--protocol** - тип протокола (возможно: **FTPFS** или **SSHFS**).

- **--rhost** - IP-адрес или имя удалённого хоста.

- **--credentials** - путь к файлу, содержащему учётные данные для осуществления операции.

- **--source** - путь к каталогу на локальном сервере, куда будет смонтирован удалённый каталог.

- **--destination** - путь к каталогу на удалённом сервере, который требуется монтировать.

- **--sendreport** - (не-)отправлять отчёт о выполнении операции по е-майл (значения: **false** / **true**).

- **--email** - адрес электронной почты, на которой будет отправлен отчёт о выполнении операции.


**Пример - для curlftpfs**

```
#!/bin/bash
/opt/exofs/bin/exofs --jobid="MOUNT FTPFS JOB1" --jobtype="mount" --protocol="FTPFS" --rhost="REMOTE_HOST_FQDN_OR_IP" --credentials="/opt/exofs/etc/mount_ftpfs_job1.conf" --source="/var/ftpfs_job1" --destination="/REMOTE_DIR" --sendreport="true" --email="YOU_EMAIL@HERE.DOMAIN"
exit 0;
```

**Пример - для sshfs**

```
#!/bin/bash
/opt/exofs/bin/exofs --jobid="MOUNT SSHFS JOB1" --jobtype="mount" --protocol="SSHFS" --rhost="REMOTE_HOST_FQDN_OR_IP" --credentials="/opt/exofs/etc/mount_sshfs_job1.conf" --source="/var/sshfs_job1" --destination="/REMOTE_DIR" --sendreport="true" --email="YOU_EMAIL@HERE.DOMAIN"
exit 0;
```

